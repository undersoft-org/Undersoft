@using Undersoft.SDK.Service;
@using Undersoft.SDK.Service.Application.Access;

@page "/account/signin"
@inject IAccountAccess _access
@inject NavigationManager _navigation
@inject IServicer _servicer


@code
{
    private AccessDialog<SignInDialog<Credentials>, Credentials> _dialog = default!;

    protected override void OnInitialized()
    {
        _dialog = _servicer.Initialize<AccessDialog<SignInDialog<Credentials>, Credentials>>();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SigningIn("Sign in");
        }
    }

    private async Task SigningIn(string title)
    {
        while(true)
        {
            Account account = new Account();

            await _dialog.Show(account.Credentials, title, "Email", "Password");

            var result = await _access.SignIn(account);

            if(result.Credentials.Authorized)
            {
                if(result.Credentials.EmailConfirmed)
                {
                    if (result.Credentials.RegistrationCompleted)
                        break;
                    _navigation.NavigateTo("/account/registration");
                }
                else
                    _navigation.NavigateTo("/account/confirmation");
            }
            title = "Sign in - " + result.Notes.Info;
        }
        _navigation.NavigateTo("");
    }
}

@using Undersoft.SDK.Instant.Proxies
@using Undersoft.SDK.Instant.Updating
@using Undersoft.SDK.Instant.Rubrics.Attributes
@using Undersoft.SDK.Service;

@page "/access/sign_up"
@inject IAccountAccess _access
@inject NavigationManager _navigation
@inject IServicer _servicer

@code
{
    private AccessDialog<SignUpDialog<Credentials>, Credentials> _dialog = default!;

    protected override async Task OnInitializedAsync()
    {
        _dialog = _servicer.Initialize<AccessDialog<SignUpDialog<Credentials>, Credentials>>();
        await SigningUp("Sign up");
    }

    private async Task SigningUp(string title, string description = "")
    {
        var notes = new AuthorizationNotes();
        var data = new GenericData<Credentials>(new Credentials(), title);
        data.SetRequired("FirstName", "LastName", "Email", "Password", "RetypePassword");
        data.Description = description;

        while (true)
        {
            await _dialog.Show(data);

            var content = _dialog.Content;
            if (content != null)
            {
                if (content.HaveNext && content.NextPath != null)
                {
                    _navigation.NavigateTo(content.NextPath);
                    return;
                }
                content.Data.UserName = $"{content.Data.FirstName} {content.Data.LastName}";

                var result = await _access.SignUp(new Account() { Credentials = content.Data });
                
                if (result.Notes.Status != SigningStatus.Failure && result.Notes.Errors == null)
                {
                    _navigation.NavigateTo("access/confirm_email");
                    return;
                }
                data.PatchFrom(result.Notes);
            }
        }        
    }
 }

@using Undersoft.SDK.Instant.Updating
@using Undersoft.SDK.Service;
@using Undersoft.SDK.Service.Application.Access;
@using Undersoft.SDK.Service.Access;

@page "/access/confirm_email/{email?}"
@inject IAccountAccess _access
@inject NavigationManager _navigation
@inject IServicer _servicer

@code
{
    private IViewDialog<Credentials> _dialog = default!;

    [Parameter]
    public string? Email { get; set; }

    protected override void OnInitialized()
    {
        _dialog = _servicer.Initialize<AccessDialog<ConfirmEmailDialog<Credentials, AccessValidator>, Credentials>>();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await ConfirmingEmail("Email confirmation", "Please check your e-mail");
    }

    private async Task ConfirmingEmail(string title, string description = "")
    {       
        var data = new ViewData<Credentials>(new Credentials() { Email = Email }, OperationType.Setup, title);
        data.SetVisible("EmailConfirmationToken");
        data.Description = description;
        data.Height = "340px";
        data.Width = "350px";
        data.Logo = "img/logo-grey.png";

        while (true)
        {          
            await _dialog.Show(data);

            var content = _dialog.Content;

            if (content != null)
            {
                var result = await _access.ConfirmEmail(new Account() { Credentials = content.Model });

                if (result.Notes.Status == SigningStatus.EmailConfirmed)
                {
                    _navigation.NavigateTo("access/register_account");
                    return;
                }
                data.ClearData();
                result.Notes.PatchTo(data);
            }
            else
            {
                _navigation.NavigateTo("");
                return;
            }
        }
    }
}

@    using Undersoft.SDK.Service;
@    using Undersoft.SDK.Service.Application.Access;

@page "/access/confirm_email"
@inject IAccountAccess _access
@inject NavigationManager _navigation
@inject IServicer _servicer

@code
{
    private IGenericDialog<Credentials> _dialog = default!;

    protected override async Task OnInitializedAsync()
    {
        _dialog = _servicer.Initialize<AccessDialog<ConfirmEmailDialog<Credentials>, Credentials>>();
        await ConfirmingEmail("Confirm email");
    }

    private async Task ConfirmingEmail(string title, string description = "")
    {
        string status = "";

        while (true)
        {
            var data = new GenericData<Credentials>(new Credentials(), title);
            data.SetRequired("EmailConfirmationToken");
            data.Description = description;
            data.Status = status;

            await _dialog.Show(data);

            var content = _dialog.Content;

            if (content != null)
            {
                if (content.HaveNext && content.NextPath != null)
                    _navigation.NavigateTo(content.NextPath);

                var result = await _access.SignIn(new Account() { Credentials = content.Data });

                if (result.Credentials.Authorized)
                {
                    if (result.Credentials.EmailConfirmed)
                    {
                        if (result.Credentials.RegistrationCompleted)
                            _navigation.NavigateTo("");

                        _navigation.NavigateTo("/account/register_account");
                    }
                    else
                        _navigation.NavigateTo("/account/confirm_email");
                }
                status = result.Notes.Info;
            }
        }
    }
}

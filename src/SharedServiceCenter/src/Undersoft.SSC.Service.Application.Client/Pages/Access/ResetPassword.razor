@using Undersoft.SDK.Instant.Updating
@using Undersoft.SDK.Service;
@using Undersoft.SDK.Service.Application.Access;

@page "/access/reset_password"
@inject IAccountAccess _access
@inject NavigationManager _navigation
@inject IServicer _servicer

@code
{
    private IGenericDialog<Credentials> _dialog = default!;

    protected override async Task OnInitializedAsync()
    {
        _dialog = _servicer.Initialize<AccessDialog<GenericEditDialog<Credentials>, Credentials>>();
        await ResettingPassword("Reset password");
    }

    private async Task ResettingPassword(string title, string description = "")
    {
        var data = new GenericData<Credentials>(new Credentials(), title);
        data.SetRequired("Email");
        data.Description = description;

        while (true)
        {
            await _dialog.Show(data);

            var content = _dialog.Content;

            if (content != null)
            {
                var result = await _access.ResetPassword(new Account() { Credentials = content.Data });  

                if(result.Notes.Status != SigningStatus.InvalidEmail && result.Notes.Status == SigningStatus.ResetPasswordNotConfirmed)
                {
                    _navigation.NavigateTo("access/confirm_password_reset");
                    return;
                }
                data.ClearData();
                data.PatchFrom(result.Notes);
            }
            else
            {
                _navigation.NavigateTo("");
                return;
            }
        }
    }
}

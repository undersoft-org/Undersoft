@using Undersoft.SDK.Updating
@using Undersoft.SDK.Service;
@using Undersoft.SDK.Service.Access

@page "/access/sign_in"

@code
{
    [Inject]
    public IAccountAccess _access { get; set; } = default!;

    [Inject]
    public NavigationManager _navigation { get; set; } = default!;

    [Inject]
    public IServicer _servicer { get; set; } = default!;

    [Inject]
    public IDialogService DialogService { get; set; } = default!;

    private IViewDialog<Credentials> _dialog = default!;

    protected override void OnInitialized()
    {
        _dialog = _servicer.Initialize<AccessDialog<SignInDialog<Credentials, AccessValidator>, Credentials>>(DialogService);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender)
            await SigningIn("Sign in");
    }    

    private async Task SigningIn(string title, string description = "")
    {
        var data = new ViewData<Credentials>(new Credentials(), OperationType.Access, title);
        data.SetRequired(nameof(Credentials.Email), nameof(Credentials.Password));
        data.SetVisible(nameof(Credentials.SaveAccountInCookies));
        data.Description = description;
        data.Height = "400px";
        data.Logo = "img/logo-black.png";

        while (true)
        {
            await _dialog.Show(data);

            var content = _dialog.Content;

            if (content != null)
            {
                if (content.HaveNext && content.NextHref != null)
                {
                    _navigation.NavigateTo(content.NextHref);
                    return;
                }

                var result = await _access.SignIn(new Account() { Credentials = content.Model });

                if (result.Credentials.Authenticated)
                {
                    if (result.Credentials.EmailConfirmed)
                        if (result.Credentials.RegistrationCompleted)
                            _navigation.NavigateTo("");
                        else
                            _navigation.NavigateTo("/access/register_account");
                    else
                        _navigation.NavigateTo($"/access/confirm_email/{result.Credentials.Email}");
                    return;
                }                

                data.ClearData();
                result.Notes.PatchTo(data);
            }
            else
            {
                _navigation.NavigateTo("");
                return;
            }
        }
    }
}
